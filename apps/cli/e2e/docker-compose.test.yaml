services:
  deploy-engine:
    image: ghcr.io/newstack-cloud/deploy-engine:nightly
    ports:
      # Use port 18325 to avoid conflicts with locally running deploy-engine on 8325
      - "18325:8325"
    environment:
      # Memfile is the default, but explicit for clarity
      BLUELINK_DEPLOY_ENGINE_STATE_STORAGE_ENGINE: memfile
      BLUELINK_DEPLOY_ENGINE_LOOPBACK_ONLY: "false"
      BLUELINK_DEPLOY_ENGINE_ENVIRONMENT: development
      BLUELINK_DEPLOY_ENGINE_LOG_LEVEL: debug
      # API key auth for test requests (simpler than OAuth2)
      BLUELINK_DEPLOY_ENGINE_AUTH_BLUELINK_API_KEYS: "test-api-key"
      # Configure S3 resolver to use MinIO
      BLUELINK_DEPLOY_ENGINE_RESOLVERS_S3_ENDPOINT: "http://minio:9000"
      # Use path-style addressing for MinIO compatibility
      # (requires deploy-engine with S3 path-style support)
      BLUELINK_DEPLOY_ENGINE_RESOLVERS_S3_USE_PATH_STYLE: "true"
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      # Health endpoint is at /v1/health (API is versioned)
      test: ["CMD", "curl", "-f", "http://localhost:8325/v1/health"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  # Setup container that creates the bucket and uploads test fixtures
  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin &&
      mc mb myminio/test-blueprints --ignore-existing &&
      mc cp /fixtures/valid.blueprint.yaml myminio/test-blueprints/ &&
      echo 'MinIO setup complete'
      "
    volumes:
      - ./testdata/fixtures:/fixtures:ro

networks:
  default:
    name: bluelink-e2e-test
