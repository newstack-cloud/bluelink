# Test plugins install resolves and installs dependencies automatically
# This test requires the mock-registry container to be running

wait_registry

# First, save API key credentials to the registry
mkdir $WORK/.bluelink/clients
cp plugins.auth.json $WORK/.bluelink/clients/plugins.auth.json
env HOME=$WORK

# Set plugin installation directory to a temp location
env BLUELINK_DEPLOY_ENGINE_PLUGIN_PATH=$WORK/plugins

# Install a plugin that depends on test-provider
# aws-link-provider depends on bluelink/test-provider@1.0.0
# Dependencies are resolved upfront and reported with a (dependency) label.
exec bluelink plugins install localhost:18080/bluelink/aws-link-provider@1.0.0
stdout 'test-provider.*installed.*dependency'
stdout 'aws-link-provider.*installed'
! stdout 'aws-link-provider.*dependency'
stdout 'Installed: 2'

# Verify both plugins were extracted
exists $WORK/plugins/bin/bluelink/test-provider/1.0.0/plugin
exists $WORK/plugins/bin/bluelink/aws-link-provider/1.0.0/plugin

# Verify manifest was updated with both entries
exists $WORK/plugins/manifest.json

-- bluelink.config.toml --
# Empty config file

-- plugins.auth.json --
{
  "localhost:18080": {
    "apiKey": "test-api-key-12345"
  }
}
