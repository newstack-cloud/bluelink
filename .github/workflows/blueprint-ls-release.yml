name: Blueprint LS Release

on:
  push:
    tags:
      - "tools/blueprint-ls/v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., tools/blueprint-ls/v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Determine tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          VERSION="${TAG##*/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  goreleaser:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: prepare
    # Use goreleaser-cross container for CGO cross-compilation (tree-sitter requires CGO)
    # This image includes cross-compilers for linux, darwin (via osxcross), and windows
    container:
      image: goreleaser/goreleaser-cross:v1.24
    env:
      CGO_ENABLED: 1
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Create version tag for GoReleaser
        run: |
          # GoReleaser OSS doesn't support monorepo tag prefixes
          # Create a local tag without the prefix for GoReleaser to detect
          git config --global --add safe.directory /__w/bluelink/bluelink
          git tag "${{ needs.prepare.outputs.version }}" HEAD

      - name: Import GPG key
        id: gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        run: |
          cd ./tools/blueprint-ls
          goreleaser release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.gpg.outputs.fingerprint }}
          GORELEASER_CURRENT_TAG: ${{ needs.prepare.outputs.version }}

      - name: Upload artifacts to existing release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          files: |
            tools/blueprint-ls/dist/*.tar.gz
            tools/blueprint-ls/dist/*.zip
            tools/blueprint-ls/dist/checksums.txt
            tools/blueprint-ls/dist/checksums.txt.sig
            tools/blueprint-ls/dist/*.sbom.json
