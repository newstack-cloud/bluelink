name: Deploy Engine Release

on:
  push:
    tags:
      - "apps/deploy-engine/v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., apps/deploy-engine/v1.0.0)"
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: newstack-cloud/deploy-engine

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Determine tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          VERSION="${TAG##*/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  goreleaser:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Create version tag for GoReleaser
        run: |
          # GoReleaser OSS doesn't support monorepo tag prefixes
          # Create a local tag without the prefix for GoReleaser to detect
          git tag "${{ needs.prepare.outputs.version }}" HEAD

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache-dependency-path: apps/deploy-engine/go.sum

      - name: Import GPG key
        id: gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
          workdir: ./apps/deploy-engine
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.gpg.outputs.fingerprint }}
          GORELEASER_CURRENT_TAG: ${{ needs.prepare.outputs.version }}
          DEPLOY_ENGINE_APPLICATION_VERSION: ${{ needs.prepare.outputs.version }}

      - name: Upload artifacts to existing release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          files: |
            apps/deploy-engine/dist/*.tar.gz
            apps/deploy-engine/dist/*.zip
            apps/deploy-engine/dist/checksums.txt
            apps/deploy-engine/dist/checksums.txt.sig
            apps/deploy-engine/dist/*.sbom.json

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [prepare, goreleaser]
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read deploy-engine description
        id: readme
        run: |
          # Extract first paragraph from README as description
          DESCRIPTION=$(sed -n '/^[^#]/p' apps/deploy-engine/README.md | head -1 | cut -c1-150)
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ !contains(needs.prepare.outputs.version, '-') }}
          labels: |
            org.opencontainers.image.title=Bluelink Deploy Engine
            org.opencontainers.image.description=${{ steps.readme.outputs.description }}
            org.opencontainers.image.documentation=https://github.com/newstack-cloud/bluelink/blob/main/apps/deploy-engine/README.md

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./apps/deploy-engine
          file: ./apps/deploy-engine/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DEPLOY_ENGINE_APPLICATION_VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  scan-image:
    name: Scan Container Image
    runs-on: ubuntu-latest
    needs: [build-docker]
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }}"
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "1" # Fail release on CRITICAL/HIGH

      - name: Run Trivy vulnerability scanner (SARIF)
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }}"
          format: "sarif"
          output: "trivy-image.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-image.sarif"
          category: "container-vulnerabilities"

  sign-and-attest:
    name: Sign and Attest Image
    runs-on: ubuntu-latest
    needs: [build-docker, scan-image]
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Sign image with cosign (keyless)
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }}

      - name: Generate container SBOM
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }} \
            -o spdx-json=container-sbom.spdx.json

      - name: Attach SBOM to image
        run: |
          cosign attach sbom --sbom container-sbom.spdx.json \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }}

      - name: Attest SBOM
        run: |
          cosign attest --yes --predicate container-sbom.spdx.json --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-docker.outputs.digest }}

      - name: Generate GitHub attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ needs.build-docker.outputs.digest }}
          push-to-registry: true

