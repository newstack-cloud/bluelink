<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package
    Name="Bluelink"
    Manufacturer="NewStack Cloud"
    Version="$(var.ProductVersion)"
    UpgradeCode="E417E6C1-4B4E-4FD1-A1FC-7E8B6D02BED5"
    Scope="perUser">

    <SummaryInformation
      Description="Bluelink - Infrastructure management simplified"
      Manufacturer="NewStack Cloud" />

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of Bluelink is already installed."
      AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Directory structure - %LOCALAPPDATA%\NewStack\Bluelink\bin -->
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="NewStackDir" Name="NewStack">
        <Directory Id="INSTALLFOLDER" Name="Bluelink">
          <Directory Id="BinFolder" Name="bin" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Components - Bluelink Manager binary -->
    <ComponentGroup Id="BinComponents" Directory="BinFolder">
      <!-- Bluelink Manager -->
      <Component Id="BluelinkManager" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="BluelinkManagerExe" Source="$(var.BinariesDir)\bluelink-manager.exe" KeyPath="yes" />
      </Component>

      <!-- PATH environment variable (user scope) -->
      <Component Id="PathEnv" Guid="3DF66E6E-7DBD-429F-A037-7D5A6F705EF0">
        <Environment
          Id="PATH"
          Name="PATH"
          Value="[BinFolder]"
          Permanent="no"
          Part="last"
          Action="set"
          System="no" />
      </Component>
    </ComponentGroup>

    <!-- Feature tree -->
    <Feature Id="Complete" Title="Bluelink" Level="1">
      <Feature Id="MainFeature" Title="Bluelink" Level="1">
        <ComponentGroupRef Id="BinComponents" />
      </Feature>
    </Feature>

    <!-- Custom action: Run bluelink-manager install after files are installed -->
    <!-- Opens a visible terminal window so user can see download progress -->
    <CustomAction
      Id="RunBluelinkInstall"
      Directory="BinFolder"
      ExeCommand="cmd.exe /c &quot;[BinFolder]bluelink-manager.exe&quot; install --no-modify-path"
      Execute="commit"
      Impersonate="yes"
      Return="check" />

    <InstallExecuteSequence>
      <!-- Run install after files are copied, only on fresh install (not upgrade/uninstall) -->
      <Custom Action="RunBluelinkInstall" After="InstallFiles" Condition="NOT Installed AND NOT REMOVE" />
    </InstallExecuteSequence>

    <!-- UI with license -->
    <ui:WixUI Id="WixUI_Minimal" />

    <!-- Exit dialog text override -->
    <WixVariable Id="WixUIExitDialogDescription" Value="Bluelink has been installed successfully!&#13;&#10;&#13;&#10;The following components were installed:&#13;&#10;  - Bluelink CLI&#13;&#10;  - Deploy Engine (running as a service)&#13;&#10;  - Blueprint Language Server&#13;&#10;&#13;&#10;Open a new terminal and run: bluelink --help" />

  </Package>
</Wix>
