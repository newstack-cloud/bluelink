<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package
    Name="Bluelink"
    Manufacturer="NewStack Cloud"
    Version="$(var.ProductVersion)"
    UpgradeCode="E417E6C1-4B4E-4FD1-A1FC-7E8B6D02BED5"
    Scope="perUser">

    <SummaryInformation
      Description="Bluelink - Infrastructure management simplified"
      Manufacturer="NewStack Cloud" />

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of Bluelink is already installed."
      AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Application icon for Add/Remove Programs -->
    <Icon Id="BluelinkIcon" SourceFile="bluelink.ico" />
    <Property Id="ARPPRODUCTICON" Value="BluelinkIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://bluelink.dev" />
    <Property Id="ARPURLUPDATEINFO" Value="https://www.bluelink.dev/docs/bluelink/installing-bluelink" />

    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Directory structure - %LOCALAPPDATA%\NewStack\Bluelink\bin -->
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="NewStackDir" Name="NewStack">
        <Directory Id="INSTALLFOLDER" Name="Bluelink">
          <Directory Id="BinFolder" Name="bin" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Start Menu shortcut directory -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="BluelinkStartMenuFolder" Name="Bluelink" />
    </StandardDirectory>

    <!-- Components - Bluelink Manager binary -->
    <ComponentGroup Id="BinComponents" Directory="BinFolder">
      <!-- Bluelink Manager -->
      <Component Id="BluelinkManager" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="BluelinkManagerExe" Source="$(var.BinariesDir)\bluelink-manager.exe" KeyPath="yes" />
      </Component>

      <!-- PATH environment variable (user scope) -->
      <Component Id="PathEnv" Guid="3DF66E6E-7DBD-429F-A037-7D5A6F705EF0">
        <Environment
          Id="PATH"
          Name="PATH"
          Value="[BinFolder]"
          Permanent="no"
          Part="last"
          Action="set"
          System="no" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu shortcut -->
    <ComponentGroup Id="ShortcutComponents" Directory="BluelinkStartMenuFolder">
      <Component Id="BluelinkShortcut" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
        <Shortcut Id="BluelinkShortcut"
          Name="Bluelink"
          Description="Infrastructure management simplified"
          Target="[SystemFolder]cmd.exe"
          Arguments="/k bluelink --help"
          WorkingDirectory="BinFolder"
          Icon="BluelinkIcon" />
        <RemoveFolder Id="RemoveBluelinkStartMenuFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\NewStack\Bluelink" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Feature tree -->
    <Feature Id="Complete" Title="Bluelink" Level="1">
      <Feature Id="MainFeature" Title="Bluelink" Level="1">
        <ComponentGroupRef Id="BinComponents" />
        <ComponentGroupRef Id="ShortcutComponents" />
      </Feature>
    </Feature>

    <!-- Custom action: Run bluelink-manager install after files are installed -->
    <CustomAction
      Id="RunBluelinkInstall"
      FileRef="BluelinkManagerExe"
      ExeCommand="install --no-modify-path"
      Execute="deferred"
      Impersonate="yes"
      Return="check" />

    <!-- Custom action: Run bluelink-manager uninstall before files are removed -->
    <CustomAction
      Id="RunBluelinkUninstall"
      FileRef="BluelinkManagerExe"
      ExeCommand="uninstall"
      Execute="deferred"
      Impersonate="yes"
      Return="ignore" />

    <InstallExecuteSequence>
      <!-- Run install after files are copied, only on fresh install (not upgrade/uninstall) -->
      <Custom Action="RunBluelinkInstall" After="InstallFiles" Condition="NOT Installed AND NOT REMOVE" />
      <!-- Run uninstall before files are removed, only on uninstall -->
      <Custom Action="RunBluelinkUninstall" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>

    <!-- InstallDir UI with license and maintenance options -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <ui:WixUI Id="WixUI_InstallDir" />

    <!-- Exit dialog text shown on successful install -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="The following components were installed:&#13;&#10;  &#x2022; Bluelink CLI&#13;&#10;  &#x2022; Deploy Engine (starts automatically at login)&#13;&#10;  &#x2022; Blueprint Language Server&#13;&#10;&#13;&#10;Open a new terminal and run: bluelink --help" />

  </Package>
</Wix>
